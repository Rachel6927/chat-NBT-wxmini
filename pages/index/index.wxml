<view class="container">
  <view class="header">
    <view class="menu-btn" bindtap="toggleSidebar">
      <image src="/img/menu.png"></image>
    </view>
    <view class="title">ChatNBT</view>
    <view class="menu-btn" bindtap="createNewChat">
      <image src="/img/newChat.png"></image>
    </view>
  </view>
  <scroll-view 
    class="message-list" 
    scroll-y="true"
    scroll-top="{{scrollTop}}"
    scroll-with-animation="true"
    enhanced="true"
  >
    <block wx:for="{{messages}}" wx:key="index">
      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view class="message {{item.role}}" wx:if="{{item.role === 'user'}}">
        <view class="avatar">
          <image src="{{item.avatar}}"></image>
        </view>
        <view class="message-content">
          <block wx:for="{{item.segments}}" wx:for-item="segment" wx:key="index">
            <!-- æ–‡æœ¬å†…å®¹ -->
            <view wx:if="{{segment.type === 'text'}}" class="message-text">
              {{segment.content}}
            </view>
            
            <!-- å›¾ç‰‡å†…å®¹ -->
            <image 
              wx:elif="{{segment.type === 'image'}}"
              src="{{segment.url}}"
              mode="aspectFit"
              class="preview-image {{expandedFiles[index] ? 'expanded' : ''}}"
              bindtap="toggleFilePreview"
              data-index="{{index}}"
            />
            
            <!-- æ–‡ä»¶å†…å®¹ -->
            <view wx:elif="{{segment.type === 'file'}}" class="message-file">
              <view class="file-preview-box">
                <view class="preview-content">
                  <view class="file-icon">ðŸ“„</view>
                  <view class="file-info">
                    <text class="file-name">{{segment.name}}</text>
                    <text class="file-size">{{segment.size}}</text>
                  </view>
                </view>
              </view>
            </view>
          </block>
          
          <!-- å¤åˆ¶æŒ‰é’® -->
          <view class="copy-message-btn" bindtap="copyMessage" data-message="{{item}}">
            <image src="/img/copy.png"></image>
          </view>
        </view>
      </view>
      
      <!-- AIå“åº” -->
      <view class="message {{item.role}}" wx:else>
        <view class="avatar">
          <image src="{{item.avatar}}"></image>
        </view>
        <view class="message-content">
          <block wx:for="{{item.segments}}" wx:for-item="segment" wx:key="index">
            <!-- æ–‡æœ¬å†…å®¹ -->
            <view wx:if="{{segment.type === 'text'}}" class="message-text">
              {{segment.content}}
            </view>
            
            <!-- ä»£ç å— -->
            <view wx:elif="{{segment.type === 'code'}}" class="code-block">
              <view class="code-header">
                <text class="language">{{segment.language}}</text>
                <view class="copy-btn" bindtap="copyCode" data-code="{{segment.content}}">
                  copy
                </view>
              </view>
              <view class="code-content">
                <text user-select="true">{{segment.content}}</text>
              </view>
            </view>
          </block>
          
          <!-- å¤åˆ¶æŒ‰é’® -->
          <view class="copy-message-btn" bindtap="copyMessage" data-message="{{item}}">
            <image src="/img/copy.png"></image>
          </view>
        </view>
      </view>
    </block>
  </scroll-view>
  <view class="input-area">
    <!-- æ–‡ä»¶é¢„è§ˆåŒºåŸŸ -->
    <view class="file-preview-area {{selectedFile ? 'active' : ''}}" wx:if="{{selectedFile}}">
      <view class="file-preview-box">
        <view class="preview-content">
          <image 
            wx:if="{{selectedFile.preview}}" 
            src="{{selectedFile.preview}}" 
            mode="aspectFit" 
            class="preview-image"
          />
          <view wx:else class="file-icon">ðŸ“„</view>
          <view class="file-info">
            <text class="file-name">{{selectedFile.name}}</text>
            <text class="file-size">{{selectedFile.formattedSize}}</text>
          </view>
        </view>
        <view class="close-btn" bindtap="removeSelectedFile">Ã—</view>
      </view>
    </view>
    <view class="input-box">
      <view class="upload-btn" bindtap="chooseDocument">
        <image src="/img/image.png" mode="aspectFit"></image>
      </view>
      <input type="text" value="{{inputValue}}" bindinput="onInput" placeholder="è¯·è¾“å…¥æ¶ˆæ¯"/>
      <view class="voice-btn" bindtap="startRecord">
        <image src="/img/voice.png"></image>
      </view>
      <view class="send-btn" bindtap="sendMessage">
        <image src="/img/send.png"></image>
      </view>
    </view>
  </view>
  <sidebar id="sidebar" isOpen="{{sidebarOpen}}" bindtoggle="toggleSidebar"></sidebar>
</view>